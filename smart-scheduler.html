<script type="text/javascript">
    // Terminal command  node-red -v -D logging.console.level=trace
    var eColor="#558006";
    var ctrl_i=0;

    RED.nodes.registerType('smart-scheduler',{
        
        category: 'vib-node',
        color: '#bdeeff',
        defaults: {
            mqttSettings: {value: "", type: "smart-scheduler-settings"},
            name: {value:""},
            rules:{value:[{setName:"Confort",setColor:"#CCCCCC",spTemp:"19"}],validate: function(rules, opt) {
                return true;
            }},
            events: {value:"[]"},
            triggerMode:{value:"triggerMode.statechange.startup"},
            topic:{value:""},
            defaultSp:{value:"5"},
            override:{value:"auto"},
            overrideDuration:{value:"120"},
            overrideTs:{value:"5"},
            overrideSp:{value:"0"},
            settingChanged:{value:"0"},
            uniqueId:{value:"SmartScheduler_1"}
        },
        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-calendar",
        label: function() {
            return this.name||"smart-scheduler";
        },
        oneditprepare: function() {
            var node = this;
           
            node.fromMoment = function(m) {
                m = moment(m);
                return {
                dow: m.day(),
                mod: m.hours() * 60 + m.minutes(),
                };
            };

            node.toMoment = function(o) {
                var day = o.dow == 0 ? 7 : o.dow;
                var m = moment('2018-01-0' + day + ' 00:00:00');
                m.hours(Math.floor(o.mod / 60));
                m.minutes(o.mod % 60);
                return m;
            };

            node.nextId = (function() {
                var id = 0;
                return function() {
                return id++;
                };
            })();

            node.maxRuleId=0;
            node.isMaxRuleId=function(id){
                if (id>node.maxRuleId){
                    node.maxRuleId=id;
                    return true
                }
                return false;
            }

            var setup = function(node) {

                $("#node-input-triggerMode").val(node.triggerMode ? node.triggerMode : 'triggerMode.statechange.startup'); 
                $("#node-input-override").val(node.override ? node.override : 'auto');        
                $("#node-input-overrideDuration").val(node.overrideDuration ? node.overrideDuration : "120");

                node.configuredEvents = [];
            
                JSON.parse(node.events).forEach(function(e) {
              
                    eventData = {
                        id: node.nextId(),
                        start: e.start,
                        end: e.end,
                        s_dow:e.s_dow,
                        s_mod:e.s_mod,
                        e_dow:e.e_dow,
                        e_mod:e.e_mod,
                        stick: true,
                        ruleIdx: parseInt(e.ruleIdx)
                    };

                    /*if(eventData.start.isAfter(eventData.end)) {
                        // start is a sunday (which is moved from date 0 to 7)
                        eventData.end.add(7, 'days');
                    }*/
                  
                    node.configuredEvents.push(eventData);
                });
                

                var colorPicker = new iro.ColorPicker("#colorPicker", {
                    width: 250,
                    color: "#f00"
                });

                function colorChangeCallback(color) {
                   console.log("ctrl colorChangeCallback:"+ctrl_i);
                   $("#node-input-temp-color_"+ctrl_i).val(color.hexString);
                   $("#cc_btn_"+ctrl_i).css('background-color',color.hexString);
                   
                  // $("#sched_btn_"+ctrl_i).css('background-color',color.hexString);
                  node.rules.find(({ruleIdx}) => ruleIdx===ctrl_i).setColor=color.hexString;
                  
                }

                colorPicker.on("color:change", colorChangeCallback);
                
                let mm=moment();
                let dt='2018-01-0'+mm.day()+" "+mm.format('HH:mm:ss');

                var calendarEl = document.querySelector('#calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                   
                    initialView: 'timeGridWeek',
                    initialDate:'2018-01-01 00:00:00',
                    headerToolbar:false,
                    dayHeaders:true,
                    allDaySlot:false,
                    slotEventOverlap:false,
                    firstDay: 1,
                    nowIndicator:true,
                    now:dt,
                    dayHeaderFormat:{ weekday: 'short' },
                    duration: '00:05:00',
                    snapDuration: '00:05:00',
                    slotMinTime:'00:00:00',
                    slotDuration:'00:30:00',
                    scrollTime: '06:00:00',
                    slotLabelInterval: '01:00:00',
                    
                    selectable: true,
                    editable: true,
                    eventOverlap:false,
                    eventTimeFormat:{
                        hour: 'numeric',
                        minute: '2-digit',
                        meridiem: false,
                        meridiem: false,
                        hour12: false
                    },
                    slotLabelFormat:{
                        hour: 'numeric',
                        minute: '2-digit',
                        omitZeroMinute: false,
                        meridiem: false,
                        hour12: false
                    },
                    eventClick: function(info) {
                        
                        node.configuredEvents = node.configuredEvents.filter(function(e) {
                            return info.event.id != e.id;
                        });
                        console.log(node.configuredEvents );
                        info.event.remove();
                    },
                    select: function(info) {
                    
                        end=info.endStr;
                        start=info.startStr;

                        m_s = moment(start);
                        m_e = moment(end);
                        
                        s_dow=m_s.day();
                        s_mod=m_s.hours()*60+m_s.minutes();
                                
                        e_dow=m_e.day();
                        e_mod=m_e.hours()*60+m_e.minutes();
                        
                        let r=node.rules.find(({ruleIdx}) => ruleIdx===ctrl_i)
                        if (r===undefined)
                            return;

                        var eventData = {
                            id: node.nextId(),
                            title: r.setName,
                            start: start,
                            end: end,
                            s_dow:s_dow,
                            s_mod:s_mod,
                            e_dow:e_dow,
                            e_mod:e_mod,
                            stick: true,
                            backgroundColor: r.setColor,
                            ruleIdx:ctrl_i
                        };

                        calendar.addEvent(eventData);

                        node.configuredEvents.push(eventData);
                    },
                    eventResize: function(info) {
                        
                        node.configuredEvents.forEach(function(e) {
                          
                            if(info.event.id == e.id) {
                                m_s = moment(info.event.startStr);
                                m_e = moment(info.event.endStr);
                                e.s_dow=m_s.day();
                                e.s_mod=m_s.hours()*60+m_s.minutes();
                                
                                e.e_dow=m_e.day();
                                e.e_mod=m_e.hours()*60+m_e.minutes();

                                e.end=info.event.endStr;
                                e.start=info.event.startStr;
                            }
                        });
                         
                    },
                    eventDrop: function(info) {   
                        
                        //if(!start.isSame(end, 'day'))
                        //    if(!start.add(1, 'day').startOf('day').isSame(end, 'minute'))
                        //        revertFunc();

                        node.configuredEvents.forEach(function(e) {
                            if(info.event.id == e.id) {
                                m_s = moment(info.event.startStr);
                                m_e = moment(info.event.endStr);
                                e.s_dow=m_s.day();
                                e.s_mod=m_s.hours()*60+m_s.minutes();
                                
                                e.e_dow=m_e.day();
                                e.e_mod=m_e.hours()*60+m_e.minutes();
                               
                                e.end=info.event.endStr;
                                e.start=info.event.startStr;
                            }
                        });
                        
                    }            
        
                });
                
                node.configuredEvents.forEach(function(e) {

                    let r=node.rules.find(({ruleIdx}) => ruleIdx==e.ruleIdx)
                    if (r===undefined)
                            return;

                    m_s = moment(e.start);
                    m_e = moment(e.end);

                    var eventData = {
                        id: e.id,
                        title: r.setName,
                        start: e.start,
                        end: e.end,
                        stick: true,
                        backgroundColor: r.setColor,
                        ruleIdx:e.ruleIdx
                    };
                    
                    calendar.addEvent(eventData);
                });

                calendar.render();
            }
          
            $('#node-input-rule-container').css('min-height','150px').css('min-width','400px').editableList({
                removable: true,
                sortable: true,
                addItem: function(container,i,opt) {
                    var rule = opt;
                    console.log(rule);
                    if ( typeof opt == 'undefined' || Object.keys(opt).length==0){
                        node.maxRuleId++;
                        rule = {setName:"Confort",setColor:"#CCCCCC",spTemp:"19",ruleIdx:node.maxRuleId};
                        node.rules.push(rule);

                    }else{
                        if (rule.ruleIdx===undefined){
                            node.maxRuleId++;
                            rule.ruleIdx=node.maxRuleId;
                        }
                        node.isMaxRuleId(parseInt(rule.ruleIdx));
                    }

                    $(container).data('data',i);
                    let fragment = document.createDocumentFragment();
                    var row1 = $('<div/>',{style:"display:flex; align-items: baseline"}).appendTo(fragment);

                    $('<label style="width:20px !important;display: inline-block; text-align: right;" ><span><i class="fa fa-sign-out"></i></span></label>').appendTo(row1);
                    $('<label style="width:20px !important;" ><span><b>'+(i+1)+'</b></span></label>').appendTo(row1);
                   
                    $('<input type="text" id="node-input-set-name_'+rule.ruleIdx+'" idx="'+rule.ruleIdx+'" class="node-input-set-name" placeholder="Set name" style="width:140px" >').appendTo(row1);
                    $('<label style="width:20px !important; display: inline-block; text-align: right; margin-right:5px;" ><span><i class="fa fa-thermometer-empty"></i></span></label>').appendTo(row1);

                    $('<input type="text" id="node-input-temp-sp_'+rule.ruleIdx+'" class="node-input-sp" placeholder="SetPoint" style="width:60px !important; text-align: right;">').appendTo(row1);
                    $('<label style="width:20px !important;display: inline-block; text-align: right; margin-right:15px;" >°C</label>').appendTo(row1);
                   
                    
                    $('<input type="text" id="node-input-temp-color_'+rule.ruleIdx+'" class="node-input-temp-color" size="7" placeholder="color" style="width:70px !important; ">&nbsp;').appendTo(row1);
                    $('<label style="width:20px !important; display: inline-block; text-align: right; margin-right:5px;margin-left:5px;"><span><i class="fa fa-paint-brush"></i></span></label>').appendTo(row1);
                    
                    $('<button type="button" id="cc_btn_'+rule.ruleIdx+'" idx="'+rule.ruleIdx+'" class="cc_btn red-ui-button red-ui-button"  style="margin-left: 5px !important; height: 32px !important;">&nbsp;&nbsp;&nbsp;</button>').appendTo(row1);
                    
                    $('<button type="button" id="sched_btn_'+rule.ruleIdx+'" idx="'+rule.ruleIdx+'" class="red-ui-button toggle my-button-group"></button>').appendTo(sched_btn_grp);
                    
                    $(".my-button-group").on("click", function(event) {
                        $(".my-button-group").removeClass("selected");
                        $(this).addClass("selected");
                        ctrl_i=$(event.target).attr('idx');
                    });
                
                    container[0].appendChild(fragment);

                    $('#node-input-set-name_'+rule.ruleIdx).val(rule.setName);
                    $('#node-input-temp-color_'+rule.ruleIdx).val(rule.setColor);
                   
                    $("#cc_btn_"+rule.ruleIdx).css('background-color',rule.setColor);
                    $('#node-input-temp-sp_'+rule.ruleIdx).val(rule.spTemp);
                    $("#sched_btn_"+rule.ruleIdx).html(rule.setName);

                    const favDialog = document.getElementById("ColorPickerDialog");
                    
                    $("#cc_btn_"+rule.ruleIdx).on('click',function(event) {
                        favDialog.showModal();
                        ctrl_i=$(event.target).attr('idx')
                       
                    });  

                    $('#node-input-set-name_'+rule.ruleIdx).keyup(function (event) {
                        
                        ctrl_i=$(event.target).attr('idx');
                       
                        $("#sched_btn_"+ctrl_i).html($('#node-input-set-name_'+ctrl_i).val());
     
                        let r=node.rules.find(({ruleIdx}) => ruleIdx===ctrl_i);
                        r.setName=$('#node-input-set-name_'+ctrl_i).val();
                        
                    });

                    $('#node-input-temp-sp_'+rule.ruleIdx).keyup(function (event) {
                        
                        ctrl_i=$(event.target).attr('idx');
                        node.rules.find(({ruleIdx}) => ruleIdx===ctrl_i).spTemp=$('#node-input-temp-sp_'+ctrl_i).val();
                        
                    });
                },
                removeItem:function(data) {
                    console.log("remove");
                    $("#sched_btn_"+i).remove();
                    console.log(data);
                },
                resizeItem: function(row,index) {
                    var originalData = $(row).data('data');
                    console.log("Resize the row for item:", originalData)
                },
                resize: function() {
                    console.log("I have changed in size")
                    var length =$('#node-input-rule-container').editableList('length');
                    console.log("length:"+length);
                    node.outputs=length;
                }
            });
            
            if (!this.rules) {

                var rule = {
                    setName:"Confort",
                    setColor:"#CCCCCC",
                    spTemp:"19",
                    ruleIdx:0
                };

                this.rules = [rule];
            }
            
            $("#node-input-name").val(this.name);
            $("#node-input-topic").val(this.topic);
            $("#node-input-default-sp").val(this.defaultSp);
            $("#node-input-uniqueId").val(this.uniqueId);
            
            $("#node-input-default-sp").keyup(function (event) {
                this.defaultSp=$('#node-input-default-sp').val();
            });
            
            $("#node-input-topic").keyup(function (event) {
                this.topic=$('#node-input-topic').val();
            });

            $("#node-input-name").keyup(function (event) {
                this.name=$('#node-input-name').val();
            });

            $("#node-input-uniqueId").keyup(function (event) {
                this.uniqueId=$('#node-uniqueId').val();
            });


            this.rules.forEach((rule,index,ar) => {
                $("#node-input-rule-container").editableList('addItem',rule);
            });

           

            $.getScript('resources/node-red-contrib-vib-smart-scheduler/moment.min.js')
            .done(function(data, textStatus, jqxhr) {
            // $.getScript('resources/node-red-contrib-vib-smart-scheduler/fullcalendar.min.js')
                $.getScript('https://cdn.jsdelivr.net/npm/@jaames/iro@5')
                .done(function(data, textStatus, jqxhr) {
                    $.getScript('https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js')
                    .done(function(data, textStatus, jqxhr){
                        setup(node);
                    })
                })
                .fail(function(jqxhr, settings, exception ){
                    console.log("failed to load fullcalendar.min.js");
                    console.log(exception);
                    console.log(exception.stack);
                });

            /*End Editprepare */    
        });
        
    },
    oneditsave: function() {
       
        var rules = $("#node-input-rule-container").editableList('items');
       
        var node = this;
        node.rules= [];

        rules.each(function(i){
            
            var rule = $(this);
            var type = rule.find(".node-input-rule-type").val();
            var r = {
                setName:rule.find(".node-input-set-name").val(),
                setColor:rule.find(".node-input-temp-color").val(),
                spTemp:rule.find(".node-input-sp").val(),
                ruleIdx:rule.find(".node-input-set-name").attr("idx")
            }
           
            node.rules.push(r);
        });
        

        node.outputs=1;
        node.inputs=1;
       
                             // use to reset;

        node.settingChanged="1"; // Refresh runtime value;
        
        node.triggerMode=$("#node-input-triggerMode").find(":selected").val();
        node.overrideDuration=$("#node-input-overrideDuration").val();
        node.override=$("#node-input-override").find(":selected").val();
        node.defaultSp=$("#node-input-default-sp").val();
        
        // Transform and store data
        //node.configuredEvents=[];    
        var events = node.configuredEvents.map(function(e) {
            return {
                id:e.id,
                start: e.start,
                end: e.end,
                ruleIdx: parseInt(e.ruleIdx),
                s_dow:e.s_dow,
                s_mod:e.s_mod,
                e_dow:e.e_dow,
                e_mod:e.e_mod
            };
        });

      node.events = JSON.stringify(events);
        console.log(events);

      delete window.calendar;

    },
    oneditresize: function() {
    }
  });

</script>

<script type="text/html" data-template-name="smart-scheduler">
    <style>
        ol#node-input-rule-container .red-ui-typedInput-container {
            flex:1;
        }
    </style>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
       
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-topic" placeholder="Topic"></input>
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> UniqueId</label>
        <input type="text" id="node-input-uniqueId" placeholder="uniqueId"></input>
    </div>
   
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="change.label.rules">rules</span></label>
        <dialog id="ColorPickerDialog"  style="width: 300px; height:320px" closed>
            <div id="colorPicker"></div>
            <form method="dialog">
              <button>OK</button>
            </form>
        </dialog>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
    <div class="form-row">      
        <p style="padding-top: 10px"><i class="fa fa-info-circle"></i> Schedule</p>
      </div>  
    <div class="form-row">
        <span id="sched_btn_grp" class="button-group">
            
        </span>
        <link rel='stylesheet' href='resources/node-red-contrib-vib-smart-scheduler/fullcalendar.min.css' />
        <style type="text/css">
          .wc-business-hours {
            font-size: 1.0em;
          }
        </style>
        <div id="calendar" style="width: 550px; border: 1px solid grey"></div>
        <div class="form-row">      
          <p style="padding-top: 10px"><i class="fa fa-info-circle"></i> Note: Marked schedule = "On Payload"</p>
        </div>    
        <div class="form-row">
            <label for="node-input-triggerMode"><i class="fa fa-play"></i> Trigger mode </label>
            <select id="node-input-triggerMode">
              <option value="triggerMode.statechange">when state changes</option>
              <option value="triggerMode.statechange.startup">when state changes + startup</option>
              <option value="triggerMode.minutely">every minute</option>
            </select>
          </div>
          <div class="form-row">
            <label for="node-input-override"><i class="fa fa-play"></i> Override </label>
            <select id="node-input-override">
              <option value="auto">auto</option>
              <option value="manual">manual</option>
              <option value="off">off</option>
            </select>
          </div>
          <div class="form-row">
            <label for="node-input-overrideDuration"><i class="fa fa-play"></i> Override Duration</label>
            <input type="text" id="node-input-overrideDuration" style="width:60px !important; text-align: right;" placeholder="min"></input>
            <label for="node-input-overrideDuration-2"> min</label>
          </div>
          <div class="form-row">
            <label for="node-input-default-sp"><i class="fa fa-tasks"></i> SP default</label>
            <input type="text" id="node-input-default-sp" style="width:60px !important; text-align: right;" placeholder="temp"></input>
            <label for="node-input-default-sp-2"> °C</label>
        </div>
        <div class="form-row">
            <label for="node-input-mqttSettings"><i class="fa fa-globe"></i> Globals</label>
            <input type="text" id="node-input-mqttSettings"></input>
          </div>
      </div>
    
    <div class="form-tips"><b>Tip:</b> This is here to help.</div>
</script>

<script type="text/html" data-help-name="smart-scheduler">
    <p>A simple node that converts the message payloads into all lower-case characters</p>
</script>